# Open Bus Stride DB

Open Bus Stride database schema, migrations and related code

* [Alembic](https://alembic.sqlalchemy.org/) is used for migrations
* [SQLAlchemy](https://docs.sqlalchemy.org/en/14/orm/) is used for the ORM

## Development using the Docker Compose environment

This is the easiest option to start development, follow these instructions: https://github.com/hasadna/open-bus-pipelines/blob/main/README.md#stride-db

For local development, see the additional functionality section: `Develop stride-db migrations from a local clone of stride-db`

## Development using local Python interpreter

It's much easier to use the Docker Compose environment, but the following can be
refferd to for more details regarding the internal processes and for development
using your local Python interpreter. 

### Install

Create virtualenv (Python 3.8)

```
python3.8 -m venv venv
```

Install dependencies

```
venv/bin/python -m pip install -r requirements.txt
```

Install the Python module

```
venv/bin/python -m pip install -e .
```

Create a `.env` file with the following contents (don't change anything, it's only a local DB)

```
. venv/bin/activate
export SQLALCHEMY_URL=postgresql://postgres:123456@localhost
```

### Use

Start a Postgresql DB

```
docker run --name stride-db -e POSTGRES_PASSWORD=123456 -p 5432:5432 -v `pwd`/.data/db:/var/lib/postgresql/data -d postgres:13
```

### Update DB to latest migration

```
. .env && alembic upgrade head
```

### Make changes to the DB model

* Make code changes in open_bus_stride_db.model
* Create an alembic autogenerated revision: `. .env && alembic revision --autogenerate -m "describe the change here"`
* Update DB to latest migration

### Run ORM code

```
. .env && python
>>> from open_bus_stride_db.db import Session
>>> from open_bus_stride_db.model import Route
>>> session = Session()
>>> session.query(Route).all()
[]
>>> session.add(Route())
>>> session.query(Route).all()
[<open_bus_stride_db.model.route.Route object at 0x7f690b889a00>]
>>> session.commit()
```

See [Alembic](https://alembic.sqlalchemy.org/) and [SQLAlchemy](https://docs.sqlalchemy.org/en/14/orm/) docs for more details


### Using the Docker image

The Docker image is used to run DB migrations

Build and run on the local DB:

```
docker build -t open_bus_stride_db . &&\
docker run --rm --network host -e SQLALCHEMY_URL open_bus_stride_db
```
